/**
 * Bluesky Social Media Post Generator
 * FOR THE KIDS - 60/30/10 (backend only)
 *
 * Generates engaging posts for Bluesky (AT Protocol) promoting:
 * - AI Solutions Store products
 * - Smartphone Zombies merch (60% to Kids DAO)
 *
 * Bluesky is a decentralized social network - content should feel
 * authentic, tech-savvy, and community-oriented.
 *
 * Posts saved to logs for review and scheduling.
 */

const https = require('https');
const fs = require('fs');
const path = require('path');

// Configuration
const LOGS_DIR = 'C:\\AiCollabForTheKids\\logs';
const STATE_FILE = path.join(LOGS_DIR, 'bluesky-generator-state.json');
const LOG_FILE = path.join(LOGS_DIR, 'bluesky-generator.log');
const POSTS_FILE = path.join(LOGS_DIR, 'bluesky-generated-posts.json');

// Bluesky API Config
const BLUESKY_HANDLE = process.env.BLUESKY_HANDLE;
const BLUESKY_PASSWORD = process.env.BLUESKY_APP_PASSWORD;
const BASE_URL = 'https://bsky.social';

// Ensure logs directory exists
if (!fs.existsSync(LOGS_DIR)) {
    fs.mkdirSync(LOGS_DIR, { recursive: true });
}

function log(message) {
    const timestamp = new Date().toISOString();
    const entry = `[${timestamp}] ${message}\n`;
    fs.appendFileSync(LOG_FILE, entry);
    console.log(entry.trim());
}

// ═══════════════════════════════════════════════════════════════
// BLUESKY POST TEMPLATES - AI PRODUCTS
// Optimized for decentralized/tech-savvy audience
// ═══════════════════════════════════════════════════════════════

const AI_PRODUCT_POSTS = [
    // Claude Droid - YouTube Automation
    {
        id: 'claude-droid-1',
        category: 'claude-droid',
        content: `What if your YouTube channel ran itself while you sleep?

Claude Droid does exactly that:
- Scrapes trending topics automatically
- AI generates scripts (via Claude API)
- Text-to-speech voiceover
- Auto-uploads 4x daily

No filming. No editing. Just consistent content.

One-time $299. No subscriptions.

ai-solutions.store

#AI #YouTubeAutomation #ContentCreation #IndieHacker #DecentralizedWeb`,
        hooks: ['automation', 'passive-income', 'no-subscription']
    },
    {
        id: 'claude-droid-2',
        category: 'claude-droid',
        content: `The math on automated content creation:

Manual: 15+ hours/week filming & editing
Automated: 0 hours (Claude Droid runs 24/7)

Time reclaimed: 780 hours/year

What would you do with an extra 780 hours?

ai-solutions.store/claude-droid

#Productivity #AI #Automation #ContentCreator #TimeManagement`,
        hooks: ['time-savings', 'productivity', 'math']
    },
    {
        id: 'claude-droid-3',
        category: 'claude-droid',
        content: `Built a YouTube Shorts automation pipeline:

Stack:
- Node.js orchestration
- Claude AI for scripts
- FFmpeg for rendering
- YouTube Data API

Creates 4 videos/day. Zero manual work.

Full source available: ai-solutions.store

#OpenSource #AI #NodeJS #YouTubeShorts #Automation`,
        hooks: ['tech-stack', 'developer', 'open-source']
    },

    // Income Droid - Monetization
    {
        id: 'income-droid-1',
        category: 'income-droid',
        content: `Most YouTube channels die because consistency is hard.

Income Droid solves this:
- Auto-generates content daily
- Tracks revenue metrics
- Posts at optimal times
- Built for monetization

Turn YouTube into a passive income stream.

$499 one-time. Own the code forever.

ai-solutions.store

#PassiveIncome #YouTubeAutomation #IndieHacker #SideHustle`,
        hooks: ['consistency', 'passive-income', 'ownership']
    },
    {
        id: 'income-droid-2',
        category: 'income-droid',
        content: `Revenue opportunities don't sleep. Your content shouldn't either.

Income Droid runs 24/7:
- Creates and posts 4x daily
- Optimizes for watch time
- Tracks AdSense + affiliates
- Zero ongoing effort

This is time arbitrage at scale.

ai-solutions.store/income-droid

#PassiveRevenue #YouTubeBot #ContentAutomation #Entrepreneurship`,
        hooks: ['always-on', 'monetization', 'arbitrage']
    },

    // Marketing Engine
    {
        id: 'marketing-engine-1',
        category: 'marketing-engine',
        content: `Running a 12-platform marketing engine from a single Node.js process.

Platforms:
- Twitter, Discord, Reddit
- Telegram, Dev.to, Hashnode
- Product Hunt, HN, LinkedIn
- And more...

~50MB RAM. Zero daily maintenance.

$199 one-time: ai-solutions.store

#MarketingAutomation #IndieHacker #NodeJS #SocialMedia`,
        hooks: ['efficiency', 'multi-platform', 'tech-specs']
    },
    {
        id: 'marketing-engine-2',
        category: 'marketing-engine',
        content: `This post was generated by an automation that runs 24/7.

Marketing Engine handles:
- AI content generation
- Platform-specific formatting
- Optimal timing
- Human-in-the-loop approval

Trade 15 hours/week for 30 minutes of review.

ai-solutions.store/marketing-engine

#Automation #AI #ContentMarketing #Productivity`,
        hooks: ['meta', 'time-savings', 'human-in-loop']
    },

    // Jules AI - DevOps
    {
        id: 'jules-ai-1',
        category: 'jules-ai',
        content: `DevOps operations eat 40-60% of small team time.

Jules AI handles it autonomously:
- Git workflow management
- Deployment orchestration
- Infrastructure monitoring
- Auto-remediation

Stop babysitting your pipeline. Let AI run it.

ai-solutions.store/jules-ai

#DevOps #AIOperations #CloudAutomation #SRE`,
        hooks: ['time-savings', 'devops', 'autonomous']
    },
    {
        id: 'jules-ai-2',
        category: 'jules-ai',
        content: `Solo founders spend more time on operations than building product.

Jules AI fixes this:
- Manages entire CI/CD pipeline
- Orchestrates multi-service releases
- Monitors + auto-remediates issues
- Deep context understanding

Deployment time: 45 min to 8 min (avg)

ai-solutions.store

#SoloFounder #DevOps #AIForDevelopers #TechAutomation`,
        hooks: ['solo-founder', 'speed', 'context']
    },

    // Affiliate System
    {
        id: 'affiliate-system-1',
        category: 'affiliate-system',
        content: `Affiliate platforms charge 20-30% + monthly fees.

What if you owned the infrastructure instead?

Affiliate System (white-label):
- Complete source code
- Unlimited affiliates
- Zero platform fees
- Your brand, your domain

Pay once. Own forever.

ai-solutions.store/affiliate-system

#AffiliateMarketing #WhiteLabel #SaaS #Ecommerce`,
        hooks: ['ownership', 'cost-savings', 'white-label']
    },
    {
        id: 'affiliate-system-2',
        category: 'affiliate-system',
        content: `The economics of platform fees are brutal:

Impact/ShareASale: $500/mo + 20% fees
Over 3 years: $30K+ minimum

Alternative: Buy the entire system once. $599.

Full source code. Self-hosted. 100% economics.

ai-solutions.store

#Bootstrapped #NoSubscription #AffiliateSoftware #IndieHacker`,
        hooks: ['math', 'economics', 'one-time-purchase']
    },

    // Dating Platform
    {
        id: 'dating-platform-1',
        category: 'dating-platform',
        content: `Dating apps have a trust problem. AI bots everywhere.

Solution: Human-verified only platform.

Dating Platform (white-label):
- Video verification system
- AI detection on messages
- Complete source code
- Subscription billing ready

Build for your niche.

ai-solutions.store/dating-platform

#DatingApp #WhiteLabel #TrustTech #NicheMarket`,
        hooks: ['trust', 'verification', 'niche']
    },

    // General AI Solutions Store
    {
        id: 'store-consultation-1',
        category: 'ai-store',
        content: `Offering $1 AI consultations.

Not a gimmick - 30 minutes of honest advice:
- What to automate first
- Which AI tools actually work
- How to avoid subscription traps

No upsells. Just help.

Book: ai-solutions.store

#AI #Consulting #IndieHacker #Automation #DecentralizedTech`,
        hooks: ['low-barrier', 'honest', 'helpful']
    },
    {
        id: 'store-no-subscription-1',
        category: 'ai-store',
        content: `Hot take: Stop paying monthly for AI tools.

Our products are one-time purchases:
- Claude Droid $299
- Income Droid $499
- Marketing Engine $199
- Jules AI $399

Own the code. Run it yourself. No vendor lock-in.

ai-solutions.store

#NoSubscription #SelfHosted #AI #IndieWeb #FOSS`,
        hooks: ['anti-saas', 'ownership', 'independence']
    },
    {
        id: 'store-stack-1',
        category: 'ai-store',
        content: `My automation tech stack (all self-hosted):

- PM2 for process management
- Node.js for orchestration
- PowerShell for Windows tasks
- Cloudflare for hosting/CDN
- Square for payments

Total monthly cost: ~$100
Monthly revenue: $2,000+

Details: ai-solutions.store

#SelfHosted #TechStack #IndieHacker #Automation`,
        hooks: ['transparency', 'tech-stack', 'profitability']
    }
];

// ═══════════════════════════════════════════════════════════════
// SMARTPHONE ZOMBIES MERCH POSTS
// 60% of profits go to Kids DAO (Verified Medical Pediatrics)
// ═══════════════════════════════════════════════════════════════

const SMARTPHONE_ZOMBIES_POSTS = [
    {
        id: 'zombies-awareness-1',
        category: 'smartphone-zombies',
        content: `We've all seen them... heads down, shuffling through life.

"Beware of Smartphone Zombies" merch is HERE!

T-Shirts | Hoodies | Phone Cases | Stickers

60% of profits go to children's medical care through Kids DAO.

Your purchase = a kid's healthcare.

#UnplugForKids #SmartphoneZombies #CharityMerch #ForTheKids`,
        hooks: ['awareness', 'charity', 'merch']
    },
    {
        id: 'zombies-irony-1',
        category: 'smartphone-zombies',
        content: `The irony: You're reading this on your phone right now.

Embrace it. Wear it. Help kids.

"Beware of Smartphone Zombies" merch
60% of profits fund children's healthcare

T-Shirts $24.99
Hoodies $44.99
Cases $29.99
Stickers $4.99

DM to order!

#SmartphoneZombies #UnplugForKids #CharityApparel`,
        hooks: ['irony', 'self-aware', 'pricing']
    },
    {
        id: 'zombies-pov-1',
        category: 'smartphone-zombies',
        content: `POV: You almost walked into a pole because you were scrolling.

Don't worry, we made merch for that.

"Beware of Smartphone Zombies"

Profits help kids:
60% goes to children's medical care through Kids DAO

Wear your self-awareness proudly.

#SmartphoneZombies #ForTheKids #MerchWithMeaning`,
        hooks: ['relatable', 'humor', 'cause']
    },
    {
        id: 'zombies-club-1',
        category: 'smartphone-zombies',
        content: `Every time you look at your phone in public, somewhere a "Smartphone Zombie" sign is laughing at you.

Join the club. Get the merch. Help the kids.

60% of every purchase goes to children's medical care.

We're all zombies here.

#UnplugForKids #SmartphoneZombies #CharityFashion`,
        hooks: ['community', 'self-deprecating', 'charity']
    },
    {
        id: 'zombies-impact-1',
        category: 'smartphone-zombies',
        content: `One t-shirt = one kid's check-up.
One hoodie = basic supplies.
One order = real impact.

Smartphone Zombies merch isn't just funny - it funds children's healthcare.

60% to Kids DAO (Verified Medical Pediatrics)

Every purchase matters.

DM to order!

#ForTheKids #CharityMerch #SmartphoneZombies #Impact`,
        hooks: ['impact', 'tangible', 'urgency']
    },
    {
        id: 'zombies-digital-detox-1',
        category: 'smartphone-zombies',
        content: `Digital detox tip: Buy the shirt, put down the phone.

Just kidding. We know you can't.

But at least your Smartphone Zombies merch will fund children's medical care while you scroll.

60% to Kids DAO.

#SmartphoneZombies #DigitalDetox #CharityMerch #UnplugForKids`,
        hooks: ['humor', 'digital-detox', 'reality']
    },
    {
        id: 'zombies-question-1',
        category: 'smartphone-zombies',
        content: `Quick question: When's the last time you looked up from your phone in public?

Exactly.

Smartphone Zombies merch - for those of us who embrace it.

Bonus: 60% of profits fund children's medical care.

Self-aware AND charitable.

#SmartphoneZombies #ForTheKids #SelfAware`,
        hooks: ['question', 'self-reflection', 'dual-purpose']
    },
    {
        id: 'zombies-new-year-1',
        category: 'smartphone-zombies',
        content: `2025 resolution: Look up from your phone more.

Reality: We both know that's not happening.

Compromise: Get Smartphone Zombies merch and at least help kids while you scroll.

60% of profits go to children's medical care.

#NewYear2025 #SmartphoneZombies #ForTheKids #CharityMerch`,
        hooks: ['timely', 'realistic', 'compromise']
    }
];

// ═══════════════════════════════════════════════════════════════
// ENGAGEMENT HOOKS - BLUESKY SPECIFIC
// ═══════════════════════════════════════════════════════════════

const ENGAGEMENT_INTROS = [
    "Genuine question for the fediverse:",
    "Something I've been thinking about:",
    "Hot take (or maybe not?):",
    "Real talk:",
    "Unpopular opinion?",
    "Thread incoming:",
    "Let me know what you think:",
    "Curious about your experience:",
    "Open discussion:",
    "Worth sharing:"
];

const ENGAGEMENT_OUTROS = [
    "\n\nThoughts?",
    "\n\nAnyone else doing this?",
    "\n\nWould love to hear your experience.",
    "\n\nAm I crazy for thinking this?",
    "\n\nWhat's your take?",
    "\n\nAgreed or nah?",
    "\n\nHit me with your hot takes.",
    "\n\nBuilding in public - feedback welcome.",
    "\n\nDropping this here for discussion."
];

// ═══════════════════════════════════════════════════════════════
// UTILITY FUNCTIONS
// ═══════════════════════════════════════════════════════════════

function getState() {
    try {
        if (fs.existsSync(STATE_FILE)) {
            return JSON.parse(fs.readFileSync(STATE_FILE, 'utf8'));
        }
    } catch (err) {
        log(`Error reading state: ${err.message}`);
    }
    return {
        lastAIIndex: -1,
        lastZombiesIndex: -1,
        totalGenerated: 0,
        history: []
    };
}

function saveState(state) {
    fs.writeFileSync(STATE_FILE, JSON.stringify(state, null, 2));
}

function getNextPost(type = 'mixed') {
    const state = getState();

    if (type === 'ai' || (type === 'mixed' && Math.random() > 0.3)) {
        // 70% chance for AI products, 30% for merch
        const nextIndex = (state.lastAIIndex + 1) % AI_PRODUCT_POSTS.length;
        return {
            post: AI_PRODUCT_POSTS[nextIndex],
            index: nextIndex,
            type: 'ai',
            state
        };
    } else {
        const nextIndex = (state.lastZombiesIndex + 1) % SMARTPHONE_ZOMBIES_POSTS.length;
        return {
            post: SMARTPHONE_ZOMBIES_POSTS[nextIndex],
            index: nextIndex,
            type: 'zombies',
            state
        };
    }
}

function addEngagementHook(content) {
    const addIntro = Math.random() > 0.7; // 30% chance
    const addOutro = Math.random() > 0.5; // 50% chance

    let enhanced = content;

    if (addIntro) {
        const intro = ENGAGEMENT_INTROS[Math.floor(Math.random() * ENGAGEMENT_INTROS.length)];
        enhanced = intro + '\n\n' + enhanced;
    }

    if (addOutro) {
        const outro = ENGAGEMENT_OUTROS[Math.floor(Math.random() * ENGAGEMENT_OUTROS.length)];
        // Don't add outro if content already ends with hashtags (keep them last)
        if (enhanced.includes('#')) {
            const parts = enhanced.split(/(\n#[^\n]+)$/);
            if (parts.length > 1) {
                enhanced = parts[0] + outro + parts[1];
            }
        } else {
            enhanced = enhanced + outro;
        }
    }

    return enhanced;
}

// ═══════════════════════════════════════════════════════════════
// BLUESKY API FUNCTIONS
// ═══════════════════════════════════════════════════════════════

function authenticate() {
    return new Promise((resolve, reject) => {
        const postData = JSON.stringify({
            identifier: BLUESKY_HANDLE,
            password: BLUESKY_PASSWORD
        });

        const options = {
            hostname: 'bsky.social',
            port: 443,
            path: '/xrpc/com.atproto.server.createSession',
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Content-Length': Buffer.byteLength(postData)
            }
        };

        const req = https.request(options, (res) => {
            let data = '';
            res.on('data', chunk => data += chunk);
            res.on('end', () => {
                try {
                    const response = JSON.parse(data);
                    if (res.statusCode === 200) {
                        resolve(response);
                    } else {
                        reject(new Error(response.error || `Auth failed: ${res.statusCode}`));
                    }
                } catch (e) {
                    reject(new Error(`Parse error: ${e.message}`));
                }
            });
        });

        req.on('error', reject);
        req.write(postData);
        req.end();
    });
}

function postToBluesky(session, content) {
    return new Promise((resolve, reject) => {
        const record = {
            text: content,
            createdAt: new Date().toISOString()
        };

        const postData = JSON.stringify({
            repo: session.did,
            collection: 'app.bsky.feed.post',
            record: record
        });

        const options = {
            hostname: 'bsky.social',
            port: 443,
            path: '/xrpc/com.atproto.repo.createRecord',
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Content-Length': Buffer.byteLength(postData),
                'Authorization': `Bearer ${session.accessJwt}`
            }
        };

        const req = https.request(options, (res) => {
            let data = '';
            res.on('data', chunk => data += chunk);
            res.on('end', () => {
                try {
                    const response = JSON.parse(data);
                    if (res.statusCode === 200 || res.statusCode === 201) {
                        resolve(response);
                    } else {
                        reject(new Error(response.error || `Post failed: ${res.statusCode}`));
                    }
                } catch (e) {
                    reject(new Error(`Parse error: ${e.message}`));
                }
            });
        });

        req.on('error', reject);
        req.write(postData);
        req.end();
    });
}

// ═══════════════════════════════════════════════════════════════
// MAIN EXECUTION
// ═══════════════════════════════════════════════════════════════

async function main() {
    const args = process.argv.slice(2);
    const postType = args.includes('--ai') ? 'ai' :
                     args.includes('--merch') ? 'zombies' :
                     args.includes('--zombies') ? 'zombies' : 'mixed';
    const shouldPost = args.includes('--post');
    const addHooks = !args.includes('--no-hooks');

    log('');
    log('='.repeat(70));
    log('BLUESKY POST GENERATOR - FOR THE KIDS');
    log('Decentralized Social Network Marketing');
    log('='.repeat(70));

    // Get next post
    const { post, index, type, state } = getNextPost(postType);

    log(`\nPost Type: ${type === 'ai' ? 'AI Products' : 'Smartphone Zombies Merch'}`);
    log(`Post ID: ${post.id}`);
    log(`Category: ${post.category}`);
    log(`Variation: ${index + 1} of ${type === 'ai' ? AI_PRODUCT_POSTS.length : SMARTPHONE_ZOMBIES_POSTS.length}`);

    // Optionally add engagement hooks
    let finalContent = post.content;
    if (addHooks) {
        finalContent = addEngagementHook(finalContent);
    }

    log(`\nCharacter Count: ${finalContent.length}/300`);
    if (finalContent.length > 300) {
        log('WARNING: Post exceeds 300 character recommendation');
    }

    log('\n' + '-'.repeat(70));
    log('GENERATED POST:');
    log('-'.repeat(70));
    console.log('\n' + finalContent + '\n');
    log('-'.repeat(70));

    // Update state
    if (type === 'ai') {
        state.lastAIIndex = index;
    } else {
        state.lastZombiesIndex = index;
    }
    state.totalGenerated = (state.totalGenerated || 0) + 1;
    state.lastGenerated = new Date().toISOString();

    // Add to history
    if (!state.history) state.history = [];
    state.history.push({
        id: post.id,
        type,
        generatedAt: new Date().toISOString(),
        posted: shouldPost,
        charCount: finalContent.length
    });
    if (state.history.length > 100) {
        state.history = state.history.slice(-100);
    }

    saveState(state);

    // Save generated posts to JSON file for review
    let generatedPosts = [];
    try {
        if (fs.existsSync(POSTS_FILE)) {
            generatedPosts = JSON.parse(fs.readFileSync(POSTS_FILE, 'utf8'));
        }
    } catch (err) {
        log(`Error reading posts file: ${err.message}`);
    }

    generatedPosts.push({
        id: post.id,
        type,
        category: post.category,
        content: finalContent,
        hooks: post.hooks,
        generatedAt: new Date().toISOString(),
        posted: false
    });

    // Keep last 50 posts
    if (generatedPosts.length > 50) {
        generatedPosts = generatedPosts.slice(-50);
    }

    fs.writeFileSync(POSTS_FILE, JSON.stringify(generatedPosts, null, 2));
    log(`\nPosts saved to: ${POSTS_FILE}`);

    // Save ready-to-post markdown
    const readyFile = path.join(LOGS_DIR, 'bluesky-ready-to-post.md');
    const mdContent = `# Bluesky Post - Ready to Post
Generated: ${new Date().toISOString()}

## Type: ${type === 'ai' ? 'AI Products' : 'Smartphone Zombies Merch'}
## Category: ${post.category}
## Character Count: ${finalContent.length}

---

\`\`\`
${finalContent}
\`\`\`

---

**Hooks Used:** ${post.hooks ? post.hooks.join(', ') : 'N/A'}

**FOR THE KIDS - 60/30/10**
`;

    fs.writeFileSync(readyFile, mdContent);
    log(`Ready-to-post saved to: ${readyFile}`);

    // Post to Bluesky if requested
    if (shouldPost) {
        if (!BLUESKY_HANDLE || !BLUESKY_PASSWORD) {
            log('\nERROR: Missing Bluesky credentials');
            log('Set BLUESKY_HANDLE and BLUESKY_APP_PASSWORD environment variables');
            log('\nTo get app password:');
            log('1. Go to Bluesky Settings > App Passwords');
            log('2. Create new app password');
            log('3. Set as BLUESKY_APP_PASSWORD');
            process.exit(1);
        }

        try {
            log('\nAuthenticating with Bluesky...');
            const session = await authenticate();
            log(`Authenticated as: ${session.handle}`);

            log('Posting to Bluesky...');
            const result = await postToBluesky(session, finalContent);

            // Extract record key from URI
            const rkey = result.uri.split('/').pop();
            const postUrl = `https://bsky.app/profile/${BLUESKY_HANDLE}/post/${rkey}`;

            log('\n' + '='.repeat(70));
            log('SUCCESS: Posted to Bluesky!');
            log(`URL: ${postUrl}`);
            log(`CID: ${result.cid}`);
            log('='.repeat(70));

            // Update the last generated post as posted
            generatedPosts[generatedPosts.length - 1].posted = true;
            generatedPosts[generatedPosts.length - 1].postUrl = postUrl;
            generatedPosts[generatedPosts.length - 1].cid = result.cid;
            fs.writeFileSync(POSTS_FILE, JSON.stringify(generatedPosts, null, 2));

        } catch (err) {
            log(`\nERROR posting to Bluesky: ${err.message}`);
            process.exit(1);
        }
    } else {
        log('\n' + '='.repeat(70));
        log('POST GENERATED (not posted)');
        log('Use --post flag to publish to Bluesky');
        log('='.repeat(70));
    }

    log('\nUsage:');
    log('  node bluesky-post-generator.cjs              # Mixed content');
    log('  node bluesky-post-generator.cjs --ai         # AI products only');
    log('  node bluesky-post-generator.cjs --merch      # Smartphone Zombies only');
    log('  node bluesky-post-generator.cjs --post       # Generate and post');
    log('  node bluesky-post-generator.cjs --no-hooks   # Skip engagement hooks');
    log('');
}

if (require.main === module) {
    main().catch(err => {
        log(`Error: ${err.message}`);
        process.exit(1);
    });
}

module.exports = {
    AI_PRODUCT_POSTS,
    SMARTPHONE_ZOMBIES_POSTS,
    ENGAGEMENT_INTROS,
    ENGAGEMENT_OUTROS,
    addEngagementHook
};
